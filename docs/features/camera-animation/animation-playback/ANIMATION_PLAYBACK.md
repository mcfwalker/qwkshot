# Client-Side Animation Playback

## Overview
This document describes the client-side components and logic responsible for executing the camera animation paths generated by the backend Prompt-to-Path (P2P) pipeline. It takes the `CameraCommand[]` (keyframes) received from the API and translates them into smooth camera movements within the Three.js scene using React Three Fiber.

## Status
âœ… **Current Status**: Functional
- Core animation playback using `AnimationController` is implemented.
- Interpolation between keyframes using `d3-ease` is functional.
- Integration with Zustand store for commands and playback state (play/pause/speed/progress) is in place.
- Coordination with the scene lock mechanism is implemented.

## Core Component: `AnimationController`
- **Location:** `src/components/viewer/AnimationController.tsx` (Likely location, verify path)
- **Purpose:** This React component, typically running within the React Three Fiber `useFrame` render loop, is the heart of the client-side animation execution.
- **Functionality:**
  - Subscribes to the Zustand store (`viewerStore`) to get the current `cameraCommands: CameraCommand[]` and playback state (`isPlaying`, `playbackSpeed`, `seekProgress`, `resetAnimation`).
  - When `isPlaying` is true, it calculates the current position in the animation sequence based on elapsed time, total duration of commands, and `playbackSpeed`.
  - It determines the two keyframes (from `cameraCommands`) the current time falls between.
  - It calculates an interpolation factor (`t`, ranging 0 to 1) between these two keyframes, applying the easing function specified in the *starting* keyframe of the segment (using `d3-ease`).
  - It uses `Vector3.lerpVectors()` to interpolate the camera's `position` and `target` between the keyframes based on the calculated factor `t`.
  - It directly updates the Three.js `camera` object's position and lookAt target in each frame.
  - Handles pausing, seeking (by adjusting its internal time calculation based on `seekProgress`), and resetting the animation state.

## Data Flow
1. UI component (e.g., `ShotCallerPanel`, `PlaybackPanel`) triggers an API call to `/api/camera-path`.
2. API responds with `CameraCommand[]`.
3. Client-side logic (e.g., in `CameraAnimationSystem` or parent component) updates the Zustand store with the received `cameraCommands` and sets `isPlaying` to true (or updates relevant state based on user action like play/pause/seek).
4. `AnimationController` (in `useFrame`) reads the commands and playback state from the store.
5. `AnimationController` performs interpolation calculations based on time and easing functions.
6. `AnimationController` updates the Three.js camera `ref` directly in each frame.

## Key Implementation Details
- **State Management:** Zustand (`viewerStore`) holds `cameraCommands`, `isPlaying`, `playbackSpeed`, `animationProgress`, `seekProgress`, `resetAnimation` flags.
- **Render Loop:** React Three Fiber's `useFrame` hook provides the per-frame update mechanism.
- **Interpolation:** `THREE.Vector3.lerpVectors()` is used for position and target interpolation.
- **Easing:** `d3-ease` library provides the easing functions (e.g., `easeLinear`, `easeQuadInOut`) referenced by name in the `CameraCommand` keyframes.
- **Camera Update:** Directly manipulating the `.position` and `.lookAt()` methods of the Three.js camera object provided via context or refs.

## Integration with Lock Mechanism
- UI components (like `PlaybackPanel`) disable playback controls if the scene is not locked (reading `isLocked` state from the store).
- Attempting to play an animation might trigger checks or user feedback if the scene isn't locked, as a valid starting `EnvironmentalAnalysis` (captured on lock) is required for reliable path generation by the backend.

## Testing Considerations
- Unit/Integration tests for the `AnimationController` logic (interpolation, time calculation, state handling).
- Manual/E2E testing with various `CameraCommand` sequences and easing functions.
- Testing pause, resume, seek, and speed change functionality.
- Testing coordination with the lock state.

## Related Components
- `SceneInterpreter` (Backend: Generates `CameraCommand[]`)
- `/api/camera-path` (Backend: API endpoint)
- Zustand `viewerStore` (Client: State Management)
- `CameraAnimationSystem.tsx` / Parent Viewer Component (Client: Orchestration, UI)
- `PlaybackPanel.tsx` / `ShotCallerPanel.tsx` (Client: UI Controls) 