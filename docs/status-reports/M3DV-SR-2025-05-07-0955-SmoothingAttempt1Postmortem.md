# Status Report: Frontend Smoothing Attempt 1 - Post-Mortem & Plan V2

**Date:** 2025-05-07
**Report ID:** M3DV-SR-2025-05-07-0955-SmoothingAttempt1Postmortem

## Session Overview
- **Focus Area(s):** Frontend Animation Smoothing (`feat/segment-smoothing` branch)
- **Goal:** Implement frontend sequential animation smoothing (Phase 1 & 2) including Catmull-Rom position paths, Slerp/LookAt orientation, and corner blending.
- **Outcome:** The attempt resulted in significant regressions across multiple primitive types, necessitating a post-mortem and reset.

## Summary of Attempt 1 (`feat/segment-smoothing`)
- Introduced `PathProcessor.ts` to pre-process backend `CameraCommand[]`.
- Implemented Catmull-Rom position spline generation.
- Attempted both Slerp and dynamic `lookAt` methods for orientation in `AnimationController.tsx`.
- Resolved initial playback clock bugs.
- Implemented corner detection and blend point injection in `PathProcessor`.
- Tuned backend orbit handler (`handleOrbitStep.ts`) waypoint density.
- Achieved visually noticeable (but artifacted) blending for dolly-to-orbit transitions.

## Key Issues & Failures
- **Fundamental Architectural Incompatibility:** The shift from per-segment LERP to a pre-processed spline/Slerp system broke compatibility with backend handlers (like `pan`, `tilt`) that relied on sequential target changes at fixed positions. The pre-processing logic (filtering, decoupled orientation) failed to preserve the necessary data structure for these primitives.
- **Widespread Regressions:** Simple, single-primitive commands (e.g., "pan left 45", "pedestal up") failed to execute correctly (no movement, incorrect orientation/tilting) even after reverting some frontend changes, indicating the issue stemmed from the core architectural change.
- **Misleading Intermediate States:** Focusing solely on improving the dolly-to-orbit transition masked underlying issues and led to cascading problems.
- **Frontend Orientation Handling:** Both dynamic `lookAt` (using a fixed target) and Slerp (when fed incomplete/incorrectly filtered orientation keyframes) failed to handle all primitive types correctly.
- **Ineffective Blending Parameter Tuning:** Efforts to tune blend constants (`BLEND_OFFSET_FRACTION`, `MIN_BLEND_OFFSET`) were largely ineffective due to geometric limitations imposed by backend waypoint density (especially short subsequent segments capping the maximum blend offset).

## Lessons Learned
- **Broad Testing is Crucial:** Significant architectural changes require thorough testing across all core functionalities at each incremental step, not just the target use case.
- **Handler Output Matters:** Frontend animation systems are highly dependent on the structure and correctness of the command sequences generated by backend handlers. The spline/Slerp approach requires handlers to represent continuous motion (position and/or orientation) with appropriate intermediate steps and durations.
- **Decoupling Position/Orientation:** While powerful, decoupling position (spline) and orientation (Slerp) requires careful management of keyframe generation and filtering in the pre-processing step (`PathProcessor`) to avoid losing critical orientation information for primitives like pan/tilt.

## Decision
The `feat/segment-smoothing` branch will be abandoned. Development will reset to the `main` branch and proceed on a new branch (`feat/frontend-smoothing-v2`) with a more cautious, incremental approach.

## Plan for Next Attempt (`feat/frontend-smoothing-v2`)
1.  **Implement `PathProcessor` for Position Spline ONLY:**
    *   Create `PathProcessor` to generate the Catmull-Rom position spline (`sampledPositions`) from the full command sequence.
    *   Initially, it should *not* filter based on position or calculate quaternions.
2.  **Modify `AnimationController` for Position Spline + Target LERP:**
    *   Update `AnimationController` to use `sampledPositions` from `PathProcessor` for camera position.
    *   **Retain the original LERP logic** from the `main` branch for interpolating the `target` vector between commands based on segment durations.
    *   **Test ALL primitives thoroughly** (pan, tilt, pedestal, dolly, zoom, orbit, simple sequences). Ensure basic functionality is preserved and positional movement is smoother.
3.  **Carefully Introduce Slerp for Orientation:**
    *   Modify `PathProcessor` to calculate `keyframeQuaternions` based on the position AND target of *each* relevant command (potentially needing adjustments to filtering logic so pan/tilt targets aren't lost).
    *   Update `AnimationController` to replace target LERP with Slerp between `keyframeQuaternions`.
    *   **Test ALL primitives thoroughly again.**
4.  **Implement Corner Blending (Phase 2):**
    *   Add corner detection and blend point injection logic to `PathProcessor` (similar to the previous attempt, but applied to a now-stable base).
    *   **Test transitions thoroughly.**
5.  **Backend Handler Density Optimization (If Needed):**
    *   Only if visual quality of transitions still requires it after frontend blending is functional, revisit backend handlers (`orbit`, `pan`, `tilt`, etc.) to potentially reduce waypoint density. 